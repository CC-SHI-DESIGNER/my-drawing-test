<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æƒ…ç·’è¦–è¦ºç ”ç©¶å¯¦é©—å®¤</title>
    <style>
        :root { --primary: #6c5ce7; --bg: #f1f3f6; }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); width: 520px; }
        .progress-bar { display: flex; margin-bottom: 20px; background: #eee; border-radius: 10px; height: 6px; }
        .progress-inner { background: var(--primary); width: 25%; transition: 0.5s; border-radius: 10px; }
        
        .step-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .mood-tag { font-size: 24px; font-weight: bold; color: var(--primary); background: #efecff; padding: 5px 20px; border-radius: 15px; }
        
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .input-group input, .input-group select { flex: 1; padding: 12px; border: 2px solid #eee; border-radius: 12px; outline: none; }

        .canvas-box { border: 3px solid #eee; border-radius: 20px; background: white; cursor: url('https://cdn-icons-png.flaticon.com/32/595/595582.png') 0 32, crosshair; position: relative; }
        canvas { display: block; width: 100%; touch-action: none; border-radius: 17px; }
        
        .toolbar { display: flex; gap: 15px; padding: 12px; background: #f8f9fa; border-bottom: 1px solid #eee; align-items: center; border-radius: 17px 17px 0 0; }
        
        #mood-desc { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 15px; margin: 15px 0; box-sizing: border-box; resize: none; font-size: 15px; }
        .btn-next { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 18px; cursor: pointer; font-weight: bold; font-size: 18px; transition: 0.3s; }
        .btn-next:hover { background: #5b4cc4; transform: translateY(-2px); }
        
        #saving-overlay { display: none; text-align: center; padding: 20px; color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>
    <div class="card">
        <div class="progress-bar"><div class="progress-inner" id="progress"></div></div>
        
        <div id="user-setup">
            <div class="input-group">
                <input type="text" id="sid" placeholder="è¼¸å…¥å­¸è™Ÿ">
                <select id="gender"><option value="å¥³">å¥³</option><option value="ç”·">ç”·</option></select>
            </div>
        </div>

        <div class="step-info">
            <div class="mood-tag" id="mood-label">å–œ</div>
            <div style="font-size: 12px; color: #999;">Step <span id="step-num">1</span> of 4</div>
        </div>

        <div class="canvas-box">
            <div class="toolbar">
                <input type="color" id="color" value="#1a1a1a">
                <span style="font-size: 13px;">è«‹ç”¨ç·šæ¢æç¹ªé€™å€‹æƒ…ç·’...</span>
                <button onclick="clearCanvas()" style="margin-left:auto; background:none; border:none; color:#999; cursor:pointer;">â™»ï¸ æ¸…ç©º</button>
            </div>
            <canvas id="canvas" width="460" height="340"></canvas>
        </div>

        <textarea id="mood-desc" rows="2" placeholder="ç°¡å–®æè¿°ä¸€ä¸‹é€™å¹…ç•«çš„å†…å®¹èˆ‡æƒ…ç·’çš„é—œè¯..."></textarea>

        <button class="btn-next" id="action-btn" onclick="nextStep()">ç¢ºèªï¼Œå­˜æª”ä¸¦ç¹¼çºŒ âœ¨</button>
        <div id="saving-overlay">æ•¸æ“šèˆ‡åœ–åƒåŒæ­¥ä¸­ï¼Œè«‹ç¨å€™... ğŸš€</div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby39jbeTZVhuMbwaxu_zbMneIRZJdZe8MozfJfuBWp2_x6eET1-3l6XQft0bTGTjGEL-Q/exec";
        const moods = ["å–œ", "æ€’", "å“€", "æ¨‚"];
        let step = 0;
        let finalData = [];
        let startTime = Date.now();

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        // åˆå§‹åŒ–ç•«å¸ƒèƒŒæ™¯ç‚ºç™½
        function clearCanvas() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        clearCanvas();

        // å¹³æ»‘ç¹ªåœ–é‚è¼¯
        canvas.addEventListener('mousedown', (e) => { 
            drawing = true;
            ctx.beginPath();
            const r = canvas.getBoundingClientRect();
            ctx.moveTo(e.clientX - r.left, e.clientY - r.top);
        });
        canvas.addEventListener('mousemove', (e) => {
            if(!drawing) return;
            const r = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - r.left, e.clientY - r.top);
            ctx.strokeStyle = document.getElementById('color').value;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
        });
        window.addEventListener('mouseup', () => drawing = false);

        async function nextStep() {
            const sid = document.getElementById('sid').value;
            if(!sid) return alert("è«‹å…ˆè¼¸å…¥å­¸è™Ÿï¼");

            // æ•æ‰ç•«é¢è½‰ç‚º Base64 åœ–ç‰‡å­—ä¸²
            const imageData = canvas.toDataURL('image/jpeg', 0.5); // å£“ç¸®å“è³ª 0.5 æ¸›å°é«”ç©
            const duration = Math.round((Date.now() - startTime) / 1000);

            finalData.push({
                id: sid,
                gender: document.getElementById('gender').value,
                mood_tag: moods[step],
                color: document.getElementById('color').value,
                description: document.getElementById('mood-desc').value,
                time_spent: duration + "s",
                image: imageData // é€™æ˜¯åœ–ç‰‡æ•¸æ“šï¼
            });

            if(step < 3) {
                step++;
                startTime = Date.now();
                document.getElementById('mood-label').innerText = moods[step];
                document.getElementById('step-num').innerText = step + 1;
                document.getElementById('progress').style.width = ((step + 1) * 25) + "%";
                document.getElementById('user-setup').style.visibility = "hidden";
                document.getElementById('mood-desc').value = "";
                clearCanvas();
            } else {
                submitFinal();
            }
        }

        async function submitFinal() {
            const btn = document.getElementById('action-btn');
            const overlay = document.getElementById('saving-overlay');
            btn.style.display = "none";
            overlay.style.display = "block";

            for(let item of finalData) {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(item)
                });
            }

            alert("å…¨éƒ¨æƒ…ç·’å·²ç¹ªè£½å®Œæˆï¼æ„Ÿè¬åƒèˆ‡ã€‚");
            location.reload(); // å¯¦é©—çµæŸé‡æ•´
        }
    </script>
</body>
</html>
