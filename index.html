<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æƒ…ç·’èª¿è‰²ç›¤å¯¦é©—å®¤</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 480px; }
        .header { text-align: center; margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .input-group input, .input-group select { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 10px; outline: none; }
        
        .mood-nav { display: flex; gap: 8px; margin-bottom: 15px; }
        .mood-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; cursor: pointer; opacity: 0.4; font-weight: bold; transition: 0.3s; }
        .mood-btn.active { opacity: 1; transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .mood-btn.done { border: 2px solid #2ecc71; opacity: 0.9; }

        .canvas-area { position: relative; background: #fff; border: 2px solid #eee; border-radius: 15px; overflow: hidden; }
        canvas { display: block; background: white; cursor: crosshair; touch-action: none; width: 100%; }
        
        .controls { display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8f9fa; border-bottom: 1px solid #eee; }
        .controls select, .controls input { padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
        
        #mood-desc { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; margin-top: 15px; box-sizing: border-box; resize: none; font-size: 14px; }
        #submit-btn { width: 100%; padding: 15px; background: #1a1a1a; color: white; border: none; border-radius: 15px; cursor: pointer; font-weight: bold; margin-top: 15px; font-size: 16px; transition: 0.3s; }
        #submit-btn:hover { background: #444; }
        #res { margin-top: 15px; padding: 15px; background: #fff9db; border-radius: 12px; display: none; font-size: 14px; color: #555; border-left: 5px solid #f1c40f; }
    </style>
</head>
<body>
    <div class="card">
        <div class="header">
            <h2 style="margin:0;">ğŸ¨ æƒ…ç·’è¦–è¦ºå¯¦é©—å®¤</h2>
            <p style="color: #888; font-size: 14px;">è«‹é¸æ“‡ä¸€å€‹æƒ…ç·’ï¼Œä¸¦ç•«å‡ºå®ƒçš„æ¨£å­</p>
        </div>

        <div class="input-group">
            <input type="text" id="sid" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ">
            <select id="gender">
                <option value="å¥³å­©">å¥³å­©</option>
                <option value="ç”·å­©">ç”·å­©</option>
            </select>
        </div>
        
        <div class="mood-nav">
            <button class="mood-btn" id="btn-å–œ" style="background:#ffeaa7" onclick="setMood('å–œ')">å–œ</button>
            <button class="mood-btn" id="btn-æ€’" style="background:#ff7675; color:white;" onclick="setMood('æ€’')">æ€’</button>
            <button class="mood-btn" id="btn-å“€" style="background:#74b9ff; color:white;" onclick="setMood('å“€')">å“€</button>
            <button class="mood-btn" id="btn-æ¨‚" style="background:#55efc4" onclick="setMood('æ¨‚')">æ¨‚</button>
        </div>

        <div class="canvas-area">
            <div class="controls">
                <select id="tool">
                    <option value="pen">ğŸ–Šï¸ ç•«ç­†</option>
                    <option value="fill">ğŸ¨ å¡«è‰²</option>
                    <option value="eraser">ğŸ§½ æ©¡çš®æ“¦</option>
                </select>
                <input type="color" id="color" value="#6c5ce7">
                <button onclick="clearCanvas()" style="margin-left:auto; cursor:pointer;">â™»ï¸ æ¸…é™¤</button>
            </div>
            <canvas id="canvas" width="420" height="300"></canvas>
        </div>

        <textarea id="mood-desc" rows="2" placeholder="è·Ÿæˆ‘åˆ†äº«ä¸€ä¸‹ï¼Œä½ ç‚ºä»€éº¼é€™æ¨£ç•«ï¼Ÿé€™ä»£è¡¨ä»€éº¼å¿ƒæƒ…ï¼Ÿ"></textarea>

        <button id="submit-btn" onclick="submitData()">å®Œæˆç¹ªè£½ä¸¦æäº¤ âœ¨</button>
        <div id="res"></div>
    </div>

    <script>
        // ã€ä¿®æ­£ã€‘ç¶²å€å·²åŠ ä¸Šå¼•è™Ÿ
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby9gh1LKcLZu3Z2Dm_ZOaYzigh9JWdwkoijXdc9p0bQ-HVSozhvtG4gaudRE1K-i7qjWA/exec";

        let curMood = "", usedFill = false, drawing = false;
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', {willReadFrequently:true});

        // åˆå§‹åŒ–ç•«å¸ƒèƒŒæ™¯ç‚ºç™½è‰²ï¼Œé˜²æ­¢å¡«è‰²å‡ºéŒ¯
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        function setMood(m) {
            curMood = m;
            document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+m).classList.add('active');
            clearCanvas();
            document.getElementById('res').style.display='none';
            document.getElementById('mood-desc').value = "";
        }

        function clearCanvas() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            usedFill = false;
        }

        // ç¹ªåœ–é‚è¼¯
        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', drawingProcess);
        window.addEventListener('mouseup', stopDraw);

        function startDraw(e) {
            if(!curMood) { alert("è«‹å…ˆé¸æ“‡ä¸Šæ–¹çš„ä¸€å€‹æƒ…ç·’æŒ‰éˆ•å–”ï¼"); return; }
            const r = canvas.getBoundingClientRect();
            const x = Math.round(e.clientX - r.left);
            const y = Math.round(e.clientY - r.top);
            
            if(document.getElementById('tool').value === 'fill') {
                floodFill(x, y, document.getElementById('color').value);
                usedFill = true;
            } else {
                drawing = true;
                ctx.beginPath();
                ctx.moveTo(x, y);
            }
        }

        function drawingProcess(e) {
            if(!drawing) return;
            const r = canvas.getBoundingClientRect();
            const t = document.getElementById('tool').value;
            ctx.lineTo(e.clientX - r.left, e.clientY - r.top);
            ctx.strokeStyle = (t === 'eraser') ? '#FFFFFF' : document.getElementById('color').value;
            ctx.lineWidth = (t === 'eraser') ? 30 : 4;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
        }

        function stopDraw() { drawing = false; }

        // å¡«è‰²æ¼”ç®—æ³•
        function floodFill(startX, startY, fillHex) {
            const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = img.data;
            const i = (startY * canvas.width + startX) * 4;
            const target = [data[i], data[i+1], data[i+2], data[i+3]];
            const fill = [parseInt(fillHex.slice(1,3),16), parseInt(fillHex.slice(3,5),16), parseInt(fillHex.slice(5,7),16)];
            if(target[0]===fill[0] && target[1]===fill[1] && target[2]===fill[2]) return;
            const q = [[startX, startY]];
            while(q.length > 0){
                const [x, y] = q.shift();
                const p = (y * canvas.width + x) * 4;
                if(Math.abs(data[p]-target[0])<30 && Math.abs(data[p+1]-target[1])<30 && Math.abs(data[p+2]-target[2])<30){
                    data[p]=fill[0]; data[p+1]=fill[1]; data[p+2]=fill[2]; data[p+3]=255;
                    if(x>0) q.push([x-1, y]); if(x<canvas.width-1) q.push([x+1, y]);
                    if(y>0) q.push([x, y-1]); if(y<canvas.height-1) q.push([x, y+1]);
                }
            }
            ctx.putImageData(img, 0, 0);
        }

        // æäº¤æ•¸æ“š
        async function submitData() {
            const sid = document.getElementById('sid').value;
            const desc = document.getElementById('mood-desc').value;
            if(!sid || !curMood) { alert("å­¸è™Ÿè·Ÿæƒ…ç·’éƒ½è¦å¡«å¯«å–”ï¼"); return; }

            const btn = document.getElementById('submit-btn');
            btn.innerText = "æ­£åœ¨åŒæ­¥åˆ° Google è¡¨æ ¼... ğŸš€";

            const feedbackMap = {
                "å–œ": "é€™é¡è‰²å¤ªæº«æš–äº†ï¼åƒé™½å…‰ä¸€æ¨£é–ƒé–ƒç™¼å…‰è€¶ï½âœ¨",
                "æ€’":
