<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visual Emotion Lab V10 - Palette Record</title>
    <style>
        :root { --primary: #6c5ce7; --bg: #f4f7f6; --danger: #ff4757; }
        * { box-sizing: border-box; touch-action: manipulation; -webkit-user-select: none; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        
        .card { background: white; width: 100%; max-width: 600px; margin: 15px; padding: 20px; border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); display: flex; flex-direction: column; }
        
        .setup-header { display: flex; gap: 10px; margin-bottom: 15px; }
        input, select { border: 2px solid #edf2f7; padding: 12px; border-radius: 12px; font-size: 15px; outline: none; }
        
        .mood-banner { text-align: center; font-size: 32px; font-weight: 800; color: var(--primary); margin: 10px 0; }
        .stat-bar { display: flex; justify-content: space-between; font-size: 13px; font-weight: bold; color: #718096; margin-bottom: 10px; padding: 0 5px; }
        
        .paint-engine { border: 2px solid #f1f2f6; border-radius: 20px; background: white; overflow: hidden; position: relative; }
        canvas { display: block; width: 100%; aspect-ratio: 4/3; background: white; cursor: crosshair; }
        
        .tool-dock { background: #f8fafc; padding: 15px; border-radius: 20px; margin-top: 15px; }
        .slider-row { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        
        #colorSlider { 
            flex: 1; -webkit-appearance: none; height: 18px; border-radius: 9px;
            background: linear-gradient(to right, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00);
        }
        #colorSlider::-webkit-slider-thumb { -webkit-appearance: none; width: 28px; height: 28px; background: white; border: 4px solid #333; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        
        .action-row { display: flex; gap: 10px; }
        .btn { flex: 1; border: none; padding: 15px; border-radius: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-undo { background: #e2e8f0; color: #4a5568; }
        .btn-clear { background: #fee2e2; color: #dc2626; }
        .btn-submit { background: var(--primary); color: white; width: 100%; margin-top: 15px; font-size: 18px; box-shadow: 0 4px 14px rgba(108, 92, 231, 0.3); }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        
        #hex-preview { font-family: monospace; background: #333; color: #0f0; padding: 4px 8px; border-radius: 6px; font-size: 12px; }
    </style>
</head>
<body>

    <div class="card">
        <div id="user-info" class="setup-header">
            <input type="text" id="sid" placeholder="å­¸è™Ÿ" style="flex:2">
            <input type="number" id="age" placeholder="å¹´é½¡" style="flex:1">
            <select id="gender"><option value="å¥³">å¥³</option><option value="ç”·">ç”·</option></select>
        </div>

        <div class="mood-banner" id="mood-title">å¿ƒæƒ…ï¼šå–œ</div>
        
        <div class="stat-bar">
            <span>ğŸ¨ é¡è‰²åºåˆ—ï¼š<span id="color-count">0</span></span>
            <span id="timer-display" style="color:var(--danger)">ç”¨æ™‚ï¼š0.0s</span>
        </div>

        <div class="paint-engine">
            <canvas id="canvas"></canvas>
        </div>

        <div class="tool-dock">
            <div class="slider-row">
                <input type="range" id="colorSlider" min="0" max="359" value="0" oninput="brushSync()">
                <span id="hex-preview">#FF0000</span>
            </div>
            <div class="slider-row">
                <input type="range" id="sizeSlider" min="2" max="40" value="8" oninput="brushSync()" style="flex:1">
                <div id="brushPoint" style="width:15px; height:15px; border-radius:50%; background:red;"></div>
            </div>
            <div class="action-row">
                <button class="btn btn-undo" onclick="undo()">â†©ï¸ å¾©åŸä¸Šä¸€æ­¥</button>
                <button class="btn btn-clear" onclick="clearCanvas()">ğŸ—‘ï¸ å…¨éƒ¨æ¸…ç©º</button>
            </div>
        </div>

        <button class="btn btn-submit" id="main-btn" onclick="processStep()">ä¿å­˜ä¸¦é€²å…¥ä¸‹ä¸€é—œ (1/4)</button>
    </div>

    <script>
        // ã€ä¿®æ”¹é»ã€‘è«‹æ›´æ›ç‚ºä½ çš„ Google éƒ¨ç½²ç¶²å€
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbypv3jKvNX2-JoBMroLyimu0fl4FDUvcCuepVhhzGEE6tOACgUwyJG4w3fv1PybgOmfzg/exec";

        const moods = ["å–œ", "æ€’", "å“€", "æ¨‚"];
        let step = 0, results = [], history = [], drawing = false, hasDrawn = false;
        let activeTime = 0, lastTick = 0, hexSequence = [];
        let h = 0, sz = 8, currentHex = "#FF0000";

        const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');

        function hslToHex(h, s, l) {
            l /= 100; const a = s * Math.min(l, 1 - l) / 100;
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`.toUpperCase();
        }

        function brushSync() {
            h = parseInt(document.getElementById('colorSlider').value);
            sz = document.getElementById('sizeSlider').value;
            currentHex = hslToHex(h, 85, 50);
            document.getElementById('hex-preview').innerText = currentHex;
            document.getElementById('brushPoint').style.background = currentHex;
            document.getElementById('brushPoint').style.width = sz + 'px';
            document.getElementById('brushPoint').style.height = sz + 'px';
        }

        function initCanvas() {
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientWidth * 0.75;
            clearCanvas();
        }

        function clearCanvas() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            history = [canvas.toDataURL()];
            hasDrawn = false; activeTime = 0; hexSequence = [];
            syncUI();
        }

        function syncUI() {
            document.getElementById('timer-display').innerText = `ç”¨æ™‚ï¼š${activeTime.toFixed(1)}s`;
            document.getElementById('color-count').innerText = hexSequence.length;
        }

        function undo() {
            if(history.length > 1) {
                history.pop();
                let img = new Image();
                img.src = history[history.length - 1];
                img.onload = () => ctx.drawImage(img, 0, 0);
            }
        }

        const getXY = (e) => {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function startPaint(e) {
            drawing = true; hasDrawn = true; lastTick = Date.now();
            if (hexSequence[hexSequence.length - 1] !== currentHex) hexSequence.push(currentHex);
            ctx.beginPath();
            const {x, y} = getXY(e);
            ctx.moveTo(x, y);
            syncUI();
        }

        function movePaint(e) {
            if (!drawing) return;
            const now = Date.now();
            activeTime += (now - lastTick) / 1000;
            lastTick = now;
            syncUI();
            const {x, y} = getXY(e);
            ctx.lineTo(x, y);
            ctx.strokeStyle = currentHex;
            ctx.lineWidth = sz;
            ctx.lineCap = 'round';
            ctx.stroke();
        }

        canvas.addEventListener('mousedown', startPaint);
        canvas.addEventListener('touchstart', (e) => { startPaint(e); e.preventDefault(); }, {passive: false});
        canvas.addEventListener('mousemove', movePaint);
        canvas.addEventListener('touchmove', (e) => { movePaint(e); e.preventDefault(); }, {passive: false});
        window.addEventListener('mouseup', () => { if(drawing){ history.push(canvas.toDataURL()); drawing = false; }});
        window.addEventListener('touchend', () => { if(drawing){ history.push(canvas.toDataURL()); drawing = false; }});

        function processStep() {
            const sid = document.getElementById('sid').value;
            if(!sid || !hasDrawn) return alert("è«‹è¼¸å…¥å­¸è™Ÿä¸¦é–‹å§‹ç¹ªè£½å…§å®¹ã€‚");

            results.push({
                id: sid, age: document.getElementById('age').value, gender: document.getElementById('gender').value,
                group: "GitHub_V10", mood: moods[step],
                color_seq: hexSequence.join(", "),
                active_time: activeTime.toFixed(1),
                desc: "UI_Hidden_Record",
                image: canvas.toDataURL('image/jpeg', 0.5)
            });

            if (step < 3) {
                step++;
                document.getElementById('mood-title').innerText = "å¿ƒæƒ…ï¼š" + moods[step];
                document.getElementById('main-btn').innerText = `ä¿å­˜ä¸¦é€²å…¥ä¸‹ä¸€é—œ (${step+1}/4)`;
                document.getElementById('user-info').style.display = "none"; // é–å®šå­¸è™Ÿ
                clearCanvas();
            } else {
                finalUpload();
            }
        }

        async function finalUpload() {
            const btn = document.getElementById('main-btn');
            btn.disabled = true; btn.innerText = "æ•¸æ“šä¸Šå‚³ä¸­ï¼Œè«‹å‹¿é—œé–‰è¦–çª—...";
            
            try {
                for (let data of results) {
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify(data)
                    });
                }
                alert("ğŸ‰ æ‰€æœ‰æ•¸æ“šåŒæ­¥æˆåŠŸï¼");
                location.reload();
            } catch (e) {
                alert("å‚³é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– GAS æ¬Šé™ã€‚");
                btn.disabled = false;
            }
        }

        window.onload = initCanvas;
        brushSync();
    </script>
</body>
</html>
