<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æƒ…ç·’è¦–è¦ºå¯¦é©—å®¤ V3.0</title>
    <style>
        :root { --primary: #6c5ce7; --bg: #f8f9fa; }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        
        .card { 
            background: white; width: 100%; max-width: 600px; margin: 10px; padding: 25px; 
            border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.05); display: flex; flex-direction: column; 
        }

        .progress-bar { display: flex; background: #eee; border-radius: 10px; height: 6px; margin-bottom: 20px; }
        .progress-inner { background: var(--primary); width: 25%; transition: 0.5s; border-radius: 10px; }

        /* é ‚éƒ¨è³‡è¨Šå€ */
        .setup-ui { display: flex; gap: 10px; margin-bottom: 15px; }
        input, select, textarea { font-size: 16px !important; padding: 12px; border: 2px solid #f0f0f0; border-radius: 12px; outline: none; }
        .mood-tag { font-size: 28px; font-weight: bold; color: var(--primary); text-align: center; margin-bottom: 15px; }

        /* æ»‘å¡Šæ§åˆ¶å€ */
        .controls-group { background: #fdfdfd; padding: 15px; border-radius: 20px; border: 1px solid #eee; margin-bottom: 15px; }
        .control-item { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .control-item:last-child { margin-bottom: 0; }
        .label-text { font-size: 14px; color: #666; width: 60px; font-weight: bold; }
        
        /* è‰²å½©æ»‘å¡Šå„ªåŒ– */
        #colorSlider { 
            flex: 1; -webkit-appearance: none; height: 12px; border-radius: 10px;
            background: linear-gradient(to right, #ff0000 0%, #ffff00 17%, #00ff00 33%, #00ffff 50%, #0000ff 67%, #ff00ff 83%, #ff0000 100%);
            outline: none;
        }
        #colorSlider::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; background: white; border: 3px solid #333; border-radius: 50%; cursor: pointer; }

        /* ç­†è§¸æ»‘å¡Šå„ªåŒ– */
        #sizeSlider { flex: 1; cursor: pointer; }
        .size-preview { width: 30px; display: flex; justify-content: center; }
        #brushIndicator { background: #333; border-radius: 50%; transition: 0.1s; }

        /* ç•«å¸ƒå€ */
        .canvas-container { position: relative; border: 2px solid #f0f0f0; border-radius: 20px; background: white; overflow: hidden; }
        canvas { display: block; width: 100%; height: auto; aspect-ratio: 4 / 3; touch-action: none; cursor: crosshair; }
        .toolbar { display: flex; padding: 10px; background: #fafafa; border-bottom: 1px solid #eee; justify-content: space-between; align-items: center; }

        #mood-desc { width: 100%; margin: 15px 0; resize: none; border-color: #f0f0f0; }
        .btn-next { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 18px; }
        #ai-res { display: none; margin-top: 20px; padding: 20px; background: #fff9db; border-radius: 15px; border-left: 6px solid #f1c40f; line-height: 1.6; }
    </style>
</head>
<body>
    <div class="card">
        <div class="progress-bar"><div class="progress-inner" id="progress"></div></div>
        
        <div id="setup-group" class="setup-ui">
            <input type="text" id="sid" placeholder="è¼¸å…¥å­¸è™Ÿ" style="flex:2;">
            <select id="gender" style="flex:1;"><option value="å¥³">å¥³</option><option value="ç”·">ç”·</option></select>
        </div>

        <div class="mood-tag" id="mood-label">å¿ƒæƒ…ï¼šå–œ</div>

        <div class="controls-group">
            <div class="control-item">
                <span class="label-text">è‰²å½©é¸æ“‡</span>
                <input type="range" id="colorSlider" min="0" max="360" value="250" oninput="updateBrush()">
            </div>
            <div class="control-item">
                <span class="label-text">ç­†è§¸å¤§å°</span>
                <input type="range" id="sizeSlider" min="1" max="40" value="5" oninput="updateBrush()">
                <div class="size-preview"><div id="brushIndicator"></div></div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="toolbar">
                <span id="brush-tip" style="font-size: 12px; color:#aaa;">è«‹é–‹å§‹æç¹ªä½ çš„æƒ…ç·’ç·šæ¢...</span>
                <button onclick="clearCanvas()" style="border:none; background:none; color:var(--primary); font-weight:bold; cursor:pointer;">â™»ï¸ æ¸…ç©º</button>
            </div>
            <canvas id="canvas"></canvas>
        </div>

        <textarea id="mood-desc" rows="2" placeholder="åˆ†äº«ä¸€ä¸‹ä½ ç‚ºä»€éº¼ä½¿ç”¨é€™æ¨£çš„é¡è‰²èˆ‡ç·šæ¢ï¼Ÿ"></textarea>

        <button class="btn-next" id="action-btn" onclick="nextStep()">ä¿å­˜ç•¶å‰å¿ƒæƒ…ï¼Œç¹¼çºŒ âœ¨</button>
        <div id="ai-res"></div>
    </div>

    <script>
        const SCRIPT_URL = "åœ¨æ­¤è²¼ä¸Šä½ çš„GoogleScriptç¶²å€";
        const moods = ["å–œ", "æ€’", "å“€", "æ¨‚"];
        const aiFeedbacks = {
            "å–œ": "é™½å…‰èˆ¬çš„ç·šæ¢ï¼ä½ çš„ç­†è§¸è·³å‹•è‘—æ„‰æ‚…çš„æ—‹å¾‹å‘¢ï½âœ¨",
            "æ€’": "å¼·çƒˆè€Œæœ‰åŠ›ï¼é€™äº›ç·šæ¢æº–ç¢ºåœ°æ•æ‰åˆ°äº†çˆ†ç™¼çš„èƒ½é‡ï¼ğŸ”¥",
            "å“€": "æº«æŸ”è€Œå®‰éœï¼Œç·šæ¢ä¸­å¸¶è‘—ä¸€ç¨®æ·±é‚ƒçš„è©©æ„...ğŸ•¯ï¸",
            "æ¨‚": "å’Œè«§çš„æ§‹åœ–ï¼æ„Ÿè¦ºå¿ƒæƒ…éƒ½è·Ÿè‘—ä½ çš„ç•«ä½œé£›æšäº†èµ·ä¾†ï½ğŸŒˆ"
        };

        let step = 0;
        let finalData = [];
        let startTime = Date.now();
        let curColor = "";
        let curSize = 5;

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const brushInd = document.getElementById('brushIndicator');
        let drawing = false;

        function updateBrush() {
            const hue = document.getElementById('colorSlider').value;
            curSize = document.getElementById('sizeSlider').value;
            curColor = `hsl(${hue}, 70%, 50%)`;
            
            // æ›´æ–°é è¦½åœ“é»
            brushInd.style.width = curSize + 'px';
            brushInd.style.height = curSize + 'px';
            brushInd.style.background = curColor;
        }
        updateBrush();

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientWidth * 0.75;
            clearCanvas();
        }
        window.addEventListener('resize', resizeCanvas);
        setTimeout(resizeCanvas, 100);

        function clearCanvas() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // ç¹ªåœ–æ ¸å¿ƒé‚è¼¯
        function getPos(e) {
            const r = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - r.left, y: clientY - r.top };
        }

        function start(e) {
            drawing = true;
            const { x, y } = getPos(e);
            ctx.beginPath();
            ctx.moveTo(x, y);
            e.preventDefault();
        }

        function move(e) {
            if(!drawing) return;
            const { x, y } = getPos(e);
            ctx.lineTo(x, y);
            ctx.strokeStyle = curColor;
            ctx.lineWidth = curSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            e.preventDefault();
        }

        canvas.addEventListener('mousedown', start);
        canvas.addEventListener('mousemove', move);
        window.addEventListener('mouseup', () => drawing = false);
        canvas.addEventListener('touchstart', start, {passive: false});
        canvas.addEventListener('touchmove', move, {passive: false});
        canvas.addEventListener('touchend', () => drawing = false);

        async function nextStep() {
            const sid = document.getElementById('sid').value;
            if(!sid) return alert("è«‹å¡«å¯«å­¸è™Ÿï¼");

            const imageData = canvas.toDataURL('image/jpeg', 0.5);
            const duration = Math.round((Date.now() - startTime) / 1000);

            finalData.push({
                id: sid,
                gender: document.getElementById('gender').value,
                mood_tag: moods[step],
                color: curColor,
                description: document.getElementById('mood-desc').value,
                time_spent: duration + "s",
                image: imageData,
                ai_fb: aiFeedbacks[moods[step]]
            });

            if(step < 3) {
                step++;
                startTime = Date.now();
                document.getElementById('mood-label').innerText = "å¿ƒæƒ…ï¼š" + moods[step];
                document.getElementById('progress').style.width = ((step + 1) * 25) + "%";
                document.getElementById('setup-group').style.display = "none";
                document.getElementById('mood-desc').value = "";
                clearCanvas();
                if(step === 3) document.getElementById('action-btn').innerText = "å…¨éƒ¨å®Œæˆï¼Œé€å‡ºæ•¸æ“š âœ¨";
            } else {
                submitFinal();
            }
        }

        async function submitFinal() {
            const btn = document.getElementById('action-btn');
            btn.disabled = true;
            btn.innerText = "æ•¸æ“šé£›å¾€é›²ç«¯ä¸­... ğŸš€";

            for(let item of finalData) {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(item) });
            }

            const aiRes = document.getElementById('ai-res');
            aiRes.style.display = "block";
            // ç¶œåˆå›é¥‹
            aiRes.innerHTML = `<strong>ã€æƒ…ç·’å¯¦é©—å ±å‘Šå®Œæˆã€‘</strong><br>é€™æ˜¯ä¸€è¶Ÿç²¾å½©çš„è¦–è¦ºæ—…ç¨‹ï¼ä½ é€éæ»‘å‹•è‰²å½©èˆ‡æ§åˆ¶ç·šæ¢ç²—ç´°ï¼Œç´°è†©åœ°å…·è±¡åŒ–äº†å››ç¨®æ ¸å¿ƒæƒ…æ„Ÿã€‚é€™äº›ç­†è§¸èˆ‡è‰²å½©çš„é¸æ“‡åæ˜ äº†ä½ ç¨ç‰¹çš„å…§å¿ƒæ™¯è§€ã€‚æ„Ÿè¬ä½ çš„åƒèˆ‡ï¼âœ¨`;
            btn.innerText = "å®Œæˆå¯¦é©—";
            alert("æ•¸æ“šå·²å…¨æ•¸æˆåŠŸä¸Šå‚³ï¼");
        }
    </script>
</body>
</html>
