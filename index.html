<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æƒ…ç·’èª¿è‰²ç›¤å¯¦é©—å®¤</title>
    <style>
        body { font-family: sans-serif; background: #fafafa; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 480px; }
        .mood-nav { display: flex; gap: 8px; margin: 15px 0; }
        .mood-btn { flex: 1; padding: 10px; border: none; border-radius: 10px; cursor: pointer; opacity: 0.3; font-weight: bold; }
        .mood-btn.active { opacity: 1; transform: scale(1.05); border: 2px solid #333; }
        .mood-btn.done { border: 2px solid #2ecc71; position: relative; }
        .mood-btn.done::after { content: "âœ“"; position: absolute; top: -5px; right: -5px; background: #2ecc71; color: white; border-radius: 50%; width: 15px; height: 15px; font-size: 10px; line-height: 15px; text-align: center; }
        canvas { border: 2px solid #eee; border-radius: 15px; background: white; cursor: crosshair; width: 100%; touch-action: none; }
        .tools { margin: 15px 0; display: flex; gap: 10px; justify-content: center; }
        #res { margin-top: 15px; padding: 15px; background: #fff9db; border-radius: 10px; display: none; font-size: 14px; color: #555; }
        #submit-btn { width: 100%; padding: 15px; background: #1a1a1a; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="card">
        <h3 style="text-align:center;">ğŸ¨ æƒ…ç·’è¦–è¦ºå¯¦é©—ç ”ç©¶</h3>
        <div style="display:flex; gap:10px;">
            <input type="text" id="sid" placeholder="è¼¸å…¥å­¸è™Ÿ" style="flex:2; padding:8px; border-radius:8px; border:1px solid #ddd;">
            <select id="gender" style="flex:1; padding:8px; border-radius:8px; border:1px solid #ddd;">
                <option value="å¥³å­©">å¥³å­©</option>
                <option value="ç”·å­©">ç”·å­©</option>
            </select>
        </div>
        <div class="mood-nav">
            <button class="mood-btn" id="btn-å–œ" style="background:#ffeaa7" onclick="setMood('å–œ')">å–œ</button>
            <button class="mood-btn" id="btn-æ€’" style="background:#ff7675; color:white;" onclick="setMood('æ€’')">æ€’</button>
            <button class="mood-btn" id="btn-å“€" style="background:#74b9ff; color:white;" onclick="setMood('å“€')">å“€</button>
            <button class="mood-btn" id="btn-æ¨‚" style="background:#55efc4" onclick="setMood('æ¨‚')">æ¨‚</button>
        </div>
        <div class="tools">
            <select id="tool">
                <option value="pen">ğŸ–Šï¸ ç•«ç­†</option>
                <option value="fill">ğŸ¨ å¡«è‰²</option>
                <option value="eraser">ğŸ§½ æ©¡çš®æ“¦</option>
            </select>
            <input type="color" id="color" value="#6c5ce7">
            <button onclick="ctx.clearRect(0,0,450,300)">â™»ï¸ é‡ä¾†</button>
        </div>
        <canvas id="canvas" width="450" height="300"></canvas>
        <button id="submit-btn" onclick="submit()">å®Œæˆä¸¦çœ‹ AI å›é¥‹ âœ¨</button>
        <div id="res"></div>
    </div>
    <script>
        // ã€é‡è¦ã€‘é€™è£¡æ›æˆä½ å¾ Google å¾—åˆ°çš„ç¶²å€
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwCTTOK3eGYRHJzGWGPQC8ONgxzNtgb_1U5gIftTBBSJToFlEtFTwaygjg3HzIB7iRP6w/exec";

        let curMood = "", usedFill = false, drawing = false;
        const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d', {willReadFrequently:true});

        function setMood(m) {
            curMood = m; usedFill = false;
            document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+m).classList.add('active');
            ctx.clearRect(0,0,450,300); document.getElementById('res').style.display='none';
        }

        canvas.addEventListener('mousedown', (e) => {
            const r = canvas.getBoundingClientRect(), x = Math.round(e.clientX-r.left), y = Math.round(e.clientY-r.top);
            if(document.getElementById('tool').value === 'fill') { floodFill(x,y,document.getElementById('color').value); usedFill=true; return; }
            drawing = true; ctx.beginPath(); ctx.moveTo(x,y);
        });
        canvas.addEventListener('mousemove', (e) => {
            if(!drawing) return;
            const r = canvas.getBoundingClientRect(), t = document.getElementById('tool').value;
            ctx.lineTo(e.clientX-r.left, e.clientY-r.top);
            ctx.strokeStyle = t==='eraser'?'#FFF':document.getElementById('color').value;
            ctx.lineWidth = t==='eraser'?30:4; ctx.lineCap='round'; ctx.stroke();
        });
        window.addEventListener('mouseup', () => drawing=false);

        const FEEDBACKS = {
            "å–œ": "é€™é¡è‰²å¤ªæº«æš–äº†ï¼åƒé™½å…‰ä¸€æ¨£é–ƒé–ƒç™¼å…‰è€¶ï½âœ¨",
            "æ€’": "æ„Ÿè¦ºåˆ°ä½ çš„æƒ…ç·’å¼µåŠ›äº†ï¼æŠŠèƒ½é‡é‡‹æ”¾å‡ºä¾†æ˜¯å°çš„å–”ï¼ğŸ’ª",
            "å“€": "é€™ç¨®é¡è‰²å¥½æº«æŸ”ï¼Œæ·¡æ·¡çš„æ†‚å‚·ä¹Ÿæœ‰ä¸€ç¨®å®‰éœçš„ç¾æ„Ÿã€‚ğŸ•¯ï¸",
            "æ¨‚": "ä½ çš„è‰²å½©å¹³è¡¡æ„Ÿè¶…æ£’ï¼è®“äººçœ‹äº†å¿ƒæƒ…å¤§å¥½ï½ğŸŒˆ"
        };

        function floodFill(startX,startY,fillHex) {
            const img=ctx.getImageData(0,0,450,300), data=img.data, i=(startY*450+startX)*4;
            const target=[data[i],data[i+1],data[i+2],data[i+3]], fill=hexToRgb(fillHex);
            if(target[0]===fill[0] && target[1]===fill[1] && target[2]===fill[2]) return;
            const q=[[startX,startY]];
            while(q.length>0){
                const [x,y]=q.shift(), p=(y*450+x)*4;
                if(Math.abs(data[p]-target[0])<25&&Math.abs(data[p+1]-target[1])<25&&Math.abs(data[p+2]-target[2])<25){
                    data[p]=fill[0]; data[p+1]=fill[1]; data[p+2]=fill[2]; data[p+3]=255;
                    if(x>0)q.push([x-1,y]); if(x<449)q.push([x+1,y]); if(y>0)q.push([x,y-1]); if(y<299)q.push([x,y+1]);
                }
            }
            ctx.putImageData(img,0,0);
        }
        function hexToRgb(h){return [parseInt(h.slice(1,3),16),parseInt(h.slice(3,5),16),parseInt(h.slice(5,7),16)];}

        async function submit() {
            if(!curMood || !document.getElementById('sid').value) return alert("é‚„æ²’å¡«å­¸è™Ÿæˆ–æƒ…ç·’å–”ï¼");
            const btn = document.getElementById('submit-btn'); btn.innerText = "æ­£åœ¨å‚³é€åˆ°é›²ç«¯... âœ¨";
            const feedback = FEEDBACKS[curMood] + (usedFill?"\nè€Œä¸”å¤§é¢ç©çš„å¡«è‰²çœ‹èµ·ä¾†å¾ˆæœ‰è³ªæ„Ÿå‘¢ï¼":"");
            
            fetch(SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({
                    id: document.getElementById('sid').value, gender: document.getElementById('gender').value,
                    mood_tag: curMood, color: document.getElementById('color').value,
                    has_fill: usedFill, ai_feedback: feedback
                })
            });

            setTimeout(() => {
                document.getElementById('res').style.display='block';
                document.getElementById('res').innerText = "ã€AI å°å¤¥ä¼´å›é¥‹ã€‘\n" + feedback;
                btn.innerText = "å®Œæˆå­˜å„²å›‰ï¼è«‹ç¹¼çºŒä¸‹ä¸€å€‹æƒ…ç·’";
                document.getElementById('btn-'+curMood).classList.add('finished');
            }, 800);
        }
    </script>
</body>

</html>

