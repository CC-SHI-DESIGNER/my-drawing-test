<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æƒ…ç·’è¦–è¦ºå¯¦é©—å®¤ V5.0</title>
    <style>
        :root { --primary: #6c5ce7; --bg: #f8f9fa; }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        .card { background: white; width: 100%; max-width: 600px; margin: 10px; padding: 25px; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.05); }
        .setup-ui { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        input, select, textarea { font-size: 16px !important; padding: 12px; border: 2px solid #f0f0f0; border-radius: 12px; outline: none; }
        .mood-tag { font-size: 28px; font-weight: bold; color: var(--primary); text-align: center; margin-bottom: 10px; }
        .controls-group { background: #fdfdfd; padding: 15px; border-radius: 20px; border: 1px solid #eee; margin-bottom: 15px; }
        .control-item { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        #colorSlider { flex: 1; -webkit-appearance: none; height: 12px; border-radius: 10px; background: linear-gradient(to right, #ff0000 0%, #ffff00 17%, #00ff00 33%, #00ffff 50%, #0000ff 67%, #ff00ff 83%, #ff0000 100%); }
        .canvas-container { position: relative; border: 2px solid #f0f0f0; border-radius: 20px; background: white; overflow: hidden; }
        canvas { display: block; width: 100%; aspect-ratio: 4 / 3; touch-action: none; cursor: crosshair; }
        .toolbar { display: flex; padding: 10px; background: #fafafa; border-bottom: 1px solid #eee; justify-content: space-between; }
        .tool-btn { border: none; background: #eee; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: bold; }
        .btn-next { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 18px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="card">
        <div id="setup-group" class="setup-ui">
            <input type="text" id="sid" placeholder="å­¸è™Ÿ" style="flex:2;">
            <input type="number" id="age" placeholder="å¹´é½¡" style="flex:1;">
            <select id="gender" style="flex:1;"><option value="å¥³">å¥³</option><option value="ç”·">ç”·</option></select>
        </div>

        <div class="mood-tag" id="mood-label">å¿ƒæƒ…ï¼šå–œ</div>

        <div class="controls-group">
            <div class="control-item">
                <input type="range" id="colorSlider" min="0" max="360" value="0" oninput="updateBrush()">
            </div>
            <div class="control-item">
                <span style="font-size:12px;">ç­†è§¸</span>
                <input type="range" id="sizeSlider" min="1" max="40" value="5" oninput="updateBrush()" style="flex:1;">
                <div style="width:30px; display:flex; justify-content:center;"><div id="brushIndicator"></div></div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="toolbar">
                <button class="tool-btn" onclick="undo()" style="background:#ffeaa7;">â¬…ï¸ å¾©åŸ</button>
                <button class="tool-btn" onclick="clearCanvas()" style="background:#fab1a0;">â™»ï¸ å…¨æ¸…</button>
            </div>
            <canvas id="canvas"></canvas>
        </div>

        <textarea id="mood-desc" rows="2" placeholder="è«‹ç°¡å–®æè¿°ç•«ä½œå…§å®¹ï¼Œæ¯”å¦‚ç¶«æ¢æˆ–è‰²å½©çš„æ§‹æ€ï¼ˆå¿…å¡«ï¼‰..." style="width:100%; margin-top:10px;"></textarea>

        <button class="btn-next" id="action-btn" onclick="nextStep()">ä¿å­˜ä¸¦ç¹¼çºŒ (1/4) âœ¨</button>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwNOO9SSG9GVc4t2wMcdMFbdrxqJxi6XKfF2OtwUO5Smmoz6yaR6Fqq5v3c4_Qhn9taIg/exec";
        const moods = ["å–œ", "æ€’", "å“€", "æ¨‚"];
        let step = 0, finalData = [], startTime = Date.now(), curColor = "red", curSize = 5, historyStack = [], hasDrawn = false, drawing = false;

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const brushInd = document.getElementById('brushIndicator');

        function updateBrush() {
            const hue = document.getElementById('colorSlider').value;
            curSize = document.getElementById('sizeSlider').value;
            curColor = `hsl(${hue}, 70%, 50%)`;
            brushInd.style.cssText = `width:${curSize}px; height:${curSize}px; background:${curColor}; border-radius:50%;`;
        }

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientWidth * 0.75;
            clearCanvas();
        }
        window.addEventListener('resize', resizeCanvas);
        setTimeout(resizeCanvas, 100);

        function clearCanvas() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveHistory();
            hasDrawn = false;
        }

        function saveHistory() { historyStack.push(canvas.toDataURL()); if(historyStack.length > 20) historyStack.shift(); }
        function undo() {
            if (historyStack.length > 1) {
                historyStack.pop();
                let img = new Image();
                img.src = historyStack[historyStack.length - 1];
                img.onload = () => { ctx.drawImage(img, 0, 0); };
            }
        }

        function getPos(e) {
            const r = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - r.left, y: clientY - r.top };
        }

        canvas.addEventListener('mousedown', start);
        canvas.addEventListener('touchstart', (e) => { start(e); e.preventDefault(); }, {passive: false});
        function start(e) { drawing = true; hasDrawn = true; const { x, y } = getPos(e); ctx.beginPath(); ctx.moveTo(x, y); }
        canvas.addEventListener('mousemove', move);
        canvas.addEventListener('touchmove', (e) => { move(e); e.preventDefault(); }, {passive: false});
        function move(e) { if(!drawing) return; const { x, y } = getPos(e); ctx.lineTo(x, y); ctx.strokeStyle = curColor; ctx.lineWidth = curSize; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.stroke(); }
        window.addEventListener('mouseup', () => { if(drawing) saveHistory(); drawing = false; });
        window.addEventListener('touchend', () => { if(drawing) saveHistory(); drawing = false; });

        async function nextStep() {
            const sid = document.getElementById('sid').value;
            const age = document.getElementById('age').value;
            const desc = document.getElementById('mood-desc').value.trim();

            if(!sid || !age) return alert("è«‹å¡«å¯«å­¸è™Ÿå’Œå¹´é½¡ï¼");
            if(!hasDrawn) return alert("è«‹ç•«å‡ºæƒ…ç·’ç·šæ¢ï¼");
            if(desc.length < 2) return alert("è«‹æè¿°ä½ çš„ç•«ä½œå…§å®¹ã€‚");

            finalData.push({
                id: sid, age: age, gender: document.getElementById('gender').value,
                mood_tag: moods[step], color: curColor, description: desc,
                time_spent: Math.round((Date.now()-startTime)/1000)+"s",
                image: canvas.toDataURL('image/jpeg', 0.5)
            });

            if(step < 3) {
                step++; startTime = Date.now();
                document.getElementById('mood-label').innerText = "å¿ƒæƒ…ï¼š" + moods[step];
                document.getElementById('setup-group').style.display = "none";
                document.getElementById('mood-desc').value = "";
                document.getElementById('action-btn').innerText = `ä¿å­˜ä¸¦ç¹¼çºŒ (${step + 1}/4) âœ¨`;
                clearCanvas();
                historyStack = []; saveHistory();
            } else {
                submitFinal();
            }
        }

        async function submitFinal() {
            const btn = document.getElementById('action-btn');
            btn.disabled = true;
            btn.innerText = "æ­£åœ¨å‚³é€æ•¸æ“š... ğŸš€";

            for(let item of finalData) {
                // ä½¿ç”¨å°è£å¾Œçš„ fetchï¼Œç¢ºä¿è·¨åŸŸè«‹æ±‚æ­£ç¢º
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(item)
                });
            }
            alert("æ•¸æ“šå·²å…¨æ•¸æˆåŠŸä¸Šå‚³ï¼æ„Ÿè¬åƒèˆ‡ã€‚");
            btn.innerText = "å¯¦é©—å®Œæˆ";
        }
        updateBrush();
    </script>
</body>
</html>
