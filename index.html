<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æƒ…ç·’è¦–è¦ºå¯¦é©—å®¤ V4.0</title>
    <style>
        :root { --primary: #6c5ce7; --bg: #f8f9fa; }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        
        .card { 
            background: white; width: 100%; max-width: 600px; margin: 10px; padding: 25px; 
            border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.05); display: flex; flex-direction: column; 
        }

        .progress-bar { display: flex; background: #eee; border-radius: 10px; height: 6px; margin-bottom: 20px; }
        .progress-inner { background: var(--primary); width: 25%; transition: 0.5s; border-radius: 10px; }

        .setup-ui { display: flex; gap: 10px; margin-bottom: 15px; }
        input, select, textarea { font-size: 16px !important; padding: 12px; border: 2px solid #f0f0f0; border-radius: 12px; outline: none; transition: 0.2s; }
        input:focus, textarea:focus { border-color: var(--primary); }
        .mood-tag { font-size: 28px; font-weight: bold; color: var(--primary); text-align: center; margin-bottom: 15px; }

        /* å¿«é¸è‰²å¡Šå€ */
        .color-presets { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .preset-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        .preset-dot.active { border-color: #333; transform: scale(1.1); }

        /* æ»‘å¡Šæ§åˆ¶å€ */
        .controls-group { background: #fdfdfd; padding: 15px; border-radius: 20px; border: 1px solid #eee; margin-bottom: 15px; }
        .control-item { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        #colorSlider { 
            flex: 1; -webkit-appearance: none; height: 12px; border-radius: 10px;
            background: linear-gradient(to right, #ff0000 0%, #ffff00 17%, #00ff00 33%, #00ffff 50%, #0000ff 67%, #ff00ff 83%, #ff0000 100%);
        }
        #colorSlider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: white; border: 3px solid #333; border-radius: 50%; }

        /* ç•«å¸ƒå€ */
        .canvas-container { position: relative; border: 2px solid #f0f0f0; border-radius: 20px; background: white; overflow: hidden; }
        canvas { display: block; width: 100%; height: auto; aspect-ratio: 4 / 3; touch-action: none; cursor: crosshair; }
        
        .toolbar { display: flex; padding: 10px; background: #fafafa; border-bottom: 1px solid #eee; justify-content: space-between; }
        .tool-btn { border: none; background: #eee; padding: 6px 12px; border-radius: 8px; font-size: 13px; cursor: pointer; font-weight: bold; }
        .tool-btn.undo { background: #ffeaa7; color: #d35400; }
        .tool-btn.clear { background: #fab1a0; color: #c0392b; }

        #mood-desc { width: 100%; margin: 15px 0; resize: none; border-color: #f0f0f0; }
        .btn-next { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 18px; }
        .btn-next:disabled { background: #ccc; cursor: not-allowed; }
        
        #ai-res { display: none; margin-top: 20px; padding: 20px; background: #fff9db; border-radius: 15px; border-left: 6px solid #f1c40f; line-height: 1.6; }
    </style>
</head>
<body>
    <div class="card">
        <div class="progress-bar"><div class="progress-inner" id="progress"></div></div>
        
        <div id="setup-group" class="setup-ui">
            <input type="text" id="sid" placeholder="è¼¸å…¥å­¸è™Ÿ" style="flex:2;">
            <select id="gender" style="flex:1;"><option value="å¥³">å¥³</option><option value="ç”·">ç”·</option></select>
        </div>

        <div class="mood-tag" id="mood-label">å¿ƒæƒ…ï¼šå–œ</div>

        <div class="color-presets" id="presets">
            <div class="preset-dot active" style="background:#ff7675;" onclick="setPreset('#ff7675', 0)"></div>
            <div class="preset-dot" style="background:#fdcb6e;" onclick="setPreset('#fdcb6e', 40)"></div>
            <div class="preset-dot" style="background:#55efc4;" onclick="setPreset('#55efc4', 160)"></div>
            <div class="preset-dot" style="background:#74b9ff;" onclick="setPreset('#74b9ff', 210)"></div>
            <div class="preset-dot" style="background:#a29bfe;" onclick="setPreset('#a29bfe', 260)"></div>
            <div class="preset-dot" style="background:#2d3436;" onclick="setPreset('#2d3436', 0)"></div>
        </div>

        <div class="controls-group">
            <div class="control-item">
                <input type="range" id="colorSlider" min="0" max="360" value="0" oninput="updateBrush()">
            </div>
            <div class="control-item">
                <span style="font-size:12px; color:#666;">ç­†è§¸</span>
                <input type="range" id="sizeSlider" min="1" max="40" value="5" oninput="updateBrush()" style="flex:1;">
                <div style="width:30px; display:flex; justify-content:center;"><div id="brushIndicator"></div></div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="toolbar">
                <button class="tool-btn undo" onclick="undo()">â¬…ï¸ å¾©åŸ (ä¸Šä¸€æ­¥)</button>
                <button class="tool-btn clear" onclick="clearCanvas()">â™»ï¸ å…¨æ¸…</button>
            </div>
            <canvas id="canvas"></canvas>
        </div>

        <textarea id="mood-desc" rows="2" placeholder="è«‹æè¿°ä½ çš„ç•«ä½œï¼ˆå¿…å¡«ï¼‰..."></textarea>

        <button class="btn-next" id="action-btn" onclick="nextStep()">ä¿å­˜ä¸¦ç¹¼çºŒ (1/4) âœ¨</button>
        <div id="ai-res"></div>
    </div>

    <script>
        const SCRIPT_URL = "åœ¨æ­¤è²¼ä¸Šä½ çš„URL";
        const moods = ["å–œ", "æ€’", "å“€", "æ¨‚"];
        let step = 0;
        let finalData = [];
        let startTime = Date.now();
        let curColor = "#ff7675";
        let curSize = 5;
        
        // ç”¨æ–¼æ’¤éŠ·åŠŸèƒ½çš„é™£åˆ—
        let historyStack = [];
        let hasDrawn = false; // æª¢æŸ¥æ˜¯å¦æœ‰ç¹ªç•«

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const brushInd = document.getElementById('brushIndicator');
        let drawing = false;

        function updateBrush() {
            const hue = document.getElementById('colorSlider').value;
            curSize = document.getElementById('sizeSlider').value;
            // å¦‚æœæ˜¯ 0 ä¸” presets æ²’é¸ï¼Œé è¨­ HSL
            curColor = `hsl(${hue}, 70%, 50%)`;
            brushInd.style.width = curSize + 'px';
            brushInd.style.height = curSize + 'px';
            brushInd.style.background = curColor;
        }

        function setPreset(hex, hue) {
            curColor = hex;
            document.getElementById('colorSlider').value = hue;
            document.querySelectorAll('.preset-dot').forEach(d => d.classList.remove('active'));
            event.target.classList.add('active');
            updateBrush();
        }

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientWidth * 0.75;
            clearCanvas();
        }
        window.addEventListener('resize', resizeCanvas);
        setTimeout(resizeCanvas, 100);

        function clearCanvas() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveHistory();
            hasDrawn = false;
        }

        // æ’¤éŠ·åŠŸèƒ½ï¼šç´€éŒ„ç•«å¸ƒç‹€æ…‹
        function saveHistory() {
            if (historyStack.length > 20) historyStack.shift();
            historyStack.push(canvas.toDataURL());
        }

        function undo() {
            if (historyStack.length > 1) {
                historyStack.pop(); // å½ˆå‡ºç•¶å‰ç‹€æ…‹
                let previousState = historyStack[historyStack.length - 1];
                let img = new Image();
                img.src = previousState;
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
            }
        }

        function getPos(e) {
            const r = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - r.left, y: clientY - r.top };
        }

        canvas.addEventListener('mousedown', start);
        canvas.addEventListener('touchstart', (e) => { start(e); e.preventDefault(); }, {passive: false});
        
        function start(e) {
            drawing = true;
            hasDrawn = true;
            const { x, y } = getPos(e);
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        canvas.addEventListener('mousemove', move);
        canvas.addEventListener('touchmove', (e) => { move(e); e.preventDefault(); }, {passive: false});

        function move(e) {
            if(!drawing) return;
            const { x, y } = getPos(e);
            ctx.lineTo(x, y);
            ctx.strokeStyle = curColor;
            ctx.lineWidth = curSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
        }

        window.addEventListener('mouseup', () => { if(drawing) saveHistory(); drawing = false; });
        window.addEventListener('touchend', () => { if(drawing) saveHistory(); drawing = false; });

        async function nextStep() {
            const sid = document.getElementById('sid').value;
            const desc = document.getElementById('mood-desc').value.trim();

            // --- ç¢ºä¿æ¯å€‹éƒ¨åˆ†éƒ½æœ‰å›å¾©çš„é˜²å‘†æª¢æŸ¥ ---
            if(!sid) return alert("è«‹å¡«å¯«å­¸è™Ÿï¼");
            if(!hasDrawn) return alert("è«‹åœ¨ç•«å¸ƒä¸Šç•«å‡ºä½ çš„æƒ…ç·’ç·šæ¢å–”ï¼");
            if(desc.length < 2) return alert("è«‹åœ¨ä¸‹æ–¹æ–‡å­—æ¡†ç°¡å–®åˆ†äº«ä¸€ä¸‹ä½ çš„å¿ƒæƒ…æè¿°ã€‚");

            const imageData = canvas.toDataURL('image/jpeg', 0.5);
            const duration = Math.round((Date.now() - startTime) / 1000);

            finalData.push({
                id: sid,
                gender: document.getElementById('gender').value,
                mood_tag: moods[step],
                color: curColor,
                description: desc,
                time_spent: duration + "s",
                image: imageData
            });

            if(step < 3) {
                step++;
                startTime = Date.now();
                document.getElementById('mood-label').innerText = "å¿ƒæƒ…ï¼š" + moods[step];
                document.getElementById('progress').style.width = ((step + 1) * 25) + "%";
                document.getElementById('setup-group').style.display = "none";
                document.getElementById('mood-desc').value = "";
                document.getElementById('action-btn').innerText = `ä¿å­˜ä¸¦ç¹¼çºŒ (${step + 1}/4) âœ¨`;
                clearCanvas();
                historyStack = [];
                saveHistory();
                if(step === 3) document.getElementById('action-btn').innerText = "å…¨éƒ¨å®Œæˆï¼Œé€å‡ºæ•¸æ“š âœ¨";
            } else {
                submitFinal();
            }
        }

        async function submitFinal() {
            const btn = document.getElementById('action-btn');
            btn.disabled = true;
            btn.innerText = "æ•¸æ“šé£›å¾€é›²ç«¯ä¸­... ğŸš€";

            for(let item of finalData) {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(item) });
            }

            document.getElementById('ai-res').style.display = "block";
            document.getElementById('ai-res').innerHTML = `<strong>ã€æƒ…ç·’å¯¦é©—å ±å‘Šå®Œæˆã€‘</strong><br>é€™æ˜¯ä¸€è¶Ÿç²¾å½©çš„è¦–è¦ºæ—…ç¨‹ï¼ä½ çš„æ¯ä¸€ç­†è§¸ã€æ¯ä¸€ç¨®è‰²å½©çš„é¸æ“‡éƒ½åæ˜ äº†ä½ ç¨ç‰¹çš„å…§å¿ƒæ™¯è§€ã€‚æ„Ÿè¬ä½ èªçœŸåœ°å®Œæˆäº†é€™é …å¿ƒç†ç ”ç©¶ï¼ğŸ’–`;
            btn.innerText = "å®Œæˆå¯¦é©—";
            alert("æ•¸æ“šå·²å…¨æ•¸æˆåŠŸä¸Šå‚³ï¼");
        }
        
        updateBrush();
        saveHistory(); // åˆå§‹åŒ–ç´€éŒ„
    </script>
</body>
</html>
