<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æƒ…ç·’è¦–è¦ºå¯¦é©—å®¤</title>
    <style>
        :root { --primary: #6c5ce7; --bg: #f5f7fa; }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh;
        }
        .card { 
            background: white; 
            width: 100%; 
            max-width: 600px; /* å¹³æ¿ä¸Šçš„æœ€å¤§å¯¬åº¦ */
            margin: 10px;
            padding: 20px; 
            border-radius: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        
        .progress-bar { display: flex; background: #eee; border-radius: 10px; height: 6px; margin-bottom: 15px; }
        .progress-inner { background: var(--primary); width: 25%; transition: 0.5s; border-radius: 10px; }
        
        .setup-ui { display: flex; gap: 10px; margin-bottom: 15px; }
        input, select, textarea { 
            font-size: 16px !important; /* é˜²æ­¢ iOS è‡ªå‹•æ”¾å¤§ */
            padding: 12px; border: 2px solid #f0f0f0; border-radius: 12px; outline: none;
        }

        .mood-tag { font-size: 24px; font-weight: bold; color: var(--primary); text-align: center; margin-bottom: 10px; }
        
        /* é‡å°æ‰‹æŒ‡è¨­è¨ˆçš„å¤§è‰²ç›¤ */
        .color-palette { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .color-dot { width: 40px; height: 40px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; }
        .color-dot.active { border-color: #333; transform: scale(1.1); }
        .custom-color { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #ddd; }

        /* ç•«å¸ƒå€åŸŸï¼šè‡ªé©æ‡‰å¯¬åº¦ */
        .canvas-container { 
            position: relative; 
            border: 2px solid #eee; 
            border-radius: 20px; 
            background: white; 
            overflow: hidden;
            width: 100%;
        }
        canvas { 
            display: block; 
            width: 100%; 
            height: auto; 
            aspect-ratio: 4 / 3; /* ç¶­æŒæ¯”ä¾‹ */
            cursor: crosshair;
            touch-action: none; /* é—œéµï¼šé˜²æ­¢ç•«ç•«æ™‚è¢å¹•æ»¾å‹• */
        }
        
        .toolbar { display: flex; padding: 10px; background: #f8f9fa; border-bottom: 1px solid #eee; justify-content: space-between; align-items: center; }
        
        textarea { width: 100%; margin: 15px 0; resize: none; }
        
        .btn-next { 
            width: 100%; padding: 18px; background: var(--primary); color: white; border: none; 
            border-radius: 18px; cursor: pointer; font-weight: bold; font-size: 18px; 
        }

        #ai-res { 
            display: none; margin-top: 20px; padding: 15px; background: #fff9db; 
            border-radius: 15px; border-left: 5px solid #f1c40f; font-size: 14px; 
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="progress-bar"><div class="progress-inner" id="progress"></div></div>
        
        <div id="setup-group" class="setup-ui">
            <input type="text" id="sid" placeholder="å­¸è™Ÿ" style="flex:2;">
            <select id="gender" style="flex:1;">
                <option value="å¥³">å¥³</option>
                <option value="ç”·">ç”·</option>
            </select>
        </div>

        <div class="mood-tag" id="mood-label">å¿ƒæƒ…ï¼šå–œ</div>

        <div class="color-palette">
            <div class="color-dot active" style="background:#ff7675;" onclick="pickColor('#ff7675', this)"></div>
            <div class="color-dot" style="background:#fdcb6e;" onclick="pickColor('#fdcb6e', this)"></div>
            <div class="color-dot" style="background:#55efc4;" onclick="pickColor('#55efc4', this)"></div>
            <div class="color-dot" style="background:#74b9ff;" onclick="pickColor('#74b9ff', this)"></div>
            <div class="color-dot" style="background:#2d3436;" onclick="pickColor('#2d3436', this)"></div>
            <input type="color" id="customColor" class="custom-color" onchange="pickColor(this.value, this)">
        </div>

        <div class="canvas-container">
            <div class="toolbar">
                <span style="font-size: 12px; color:#888;">è«‹ç•«å‡ºé€™å€‹æƒ…ç·’çš„ç·šæ¢æˆ–åœ–åƒ</span>
                <button onclick="clearCanvas()" style="border:none; background:none; color:var(--primary); font-weight:bold;">â™»ï¸ æ¸…ç©º</button>
            </div>
            <canvas id="canvas"></canvas>
        </div>

        <textarea id="mood-desc" rows="2" placeholder="ç‚ºä»€éº¼ç•«é€™äº›ç·šæ¢ï¼Ÿåˆ†äº«ä¸€ä¸‹ä½ çš„å¿ƒæƒ…..."></textarea>

        <button class="btn-next" id="action-btn" onclick="nextStep()">ä¿å­˜ç•¶å‰å¿ƒæƒ…ï¼Œç¹¼çºŒ âœ¨</button>
        <div id="ai-res"></div>
    </div>

    <script>
        const SCRIPT_URL = "åœ¨æ­¤è²¼ä¸Šä½ çš„GoogleScriptç¶²å€";
        const moods = ["å–œ", "æ€’", "å“€", "æ¨‚"];
        const aiFeedbacks = {
            "å–œ": "é™½å…‰èˆ¬çš„ç·šæ¢ï¼ä½ çš„ç­†è§¸è·³å‹•è‘—æ„‰æ‚…çš„æ—‹å¾‹å‘¢ï½âœ¨",
            "æ€’": "å¼·çƒˆè€Œæœ‰åŠ›ï¼é€™äº›ç·šæ¢æº–ç¢ºåœ°æ•æ‰åˆ°äº†çˆ†ç™¼çš„èƒ½é‡ï¼ğŸ”¥",
            "å“€": "æº«æŸ”è€Œå®‰éœï¼Œç·šæ¢ä¸­å¸¶è‘—ä¸€ç¨®æ·±é‚ƒçš„è©©æ„...ğŸ•¯ï¸",
            "æ¨‚": "å’Œè«§çš„æ§‹åœ–ï¼æ„Ÿè¦ºå¿ƒæƒ…éƒ½è·Ÿè‘—ä½ çš„ç•«ä½œé£›æšäº†èµ·ä¾†ï½ğŸŒˆ"
        };

        let step = 0;
        let finalData = [];
        let startTime = Date.now();
        let selectedColor = "#ff7675";

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        // èª¿æ•´ç•«å¸ƒå¯¦éš›åƒç´ å¤§å°
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientWidth * 0.75;
            clearCanvas();
        }
        window.addEventListener('resize', resizeCanvas);
        setTimeout(resizeCanvas, 100);

        function clearCanvas() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function pickColor(c, el) {
            selectedColor = c;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
            if(el.classList && el.classList.contains('color-dot')) el.classList.add('active');
        }

        // --- è§¸æ§èˆ‡æ»‘é¼ é€šç”¨ç¹ªåœ–é‚è¼¯ ---
        function getPos(e) {
            const r = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - r.left, y: clientY - r.top };
        }

        function start(e) {
            drawing = true;
            const { x, y } = getPos(e);
            ctx.beginPath();
            ctx.moveTo(x, y);
            e.preventDefault();
        }

        function move(e) {
            if(!drawing) return;
            const { x, y } = getPos(e);
            ctx.lineTo(x, y);
            ctx.strokeStyle = selectedColor;
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            e.preventDefault();
        }

        function stop() { drawing = false; }

        canvas.addEventListener('mousedown', start);
        canvas.addEventListener('mousemove', move);
        window.addEventListener('mouseup', stop);
        
        canvas.addEventListener('touchstart', start, {passive: false});
        canvas.addEventListener('touchmove', move, {passive: false});
        canvas.addEventListener('touchend', stop);

        async function nextStep() {
            const sid = document.getElementById('sid').value;
            if(!sid) return alert("è«‹å¡«å¯«å­¸è™Ÿï¼");

            const imageData = canvas.toDataURL('image/jpeg', 0.5);
            const duration = Math.round((Date.now() - startTime) / 1000);

            finalData.push({
                id: sid,
                gender: document.getElementById('gender').value,
                mood_tag: moods[step],
                color: selectedColor,
                description: document.getElementById('mood-desc').value,
                time_spent: duration + "s",
                image: imageData
            });

            if(step < 3) {
                step++;
                startTime = Date.now();
                document.getElementById('mood-label').innerText = "å¿ƒæƒ…ï¼š" + moods[step];
                document.getElementById('progress').style.width = ((step + 1) * 25) + "%";
                document.getElementById('setup-group').style.display = "none";
                document.getElementById('mood-desc').value = "";
                clearCanvas();
                if(step === 3) document.getElementById('action-btn').innerText = "é€å‡ºæ‰€æœ‰å¯¦é©—æ•¸æ“š âœ¨";
            } else {
                submitFinal();
            }
        }

        async function submitFinal() {
            const btn = document.getElementById('action-btn');
            btn.disabled = true;
            btn.innerText = "æ­£åœ¨é£›é€ŸåŒæ­¥... ğŸš€";

            for(let item of finalData) {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(item) });
            }

            const aiRes = document.getElementById('ai-res');
            aiRes.style.display = "block";
            aiRes.innerHTML = "<strong>ã€å¯¦é©—å®Œæˆã€‘</strong><br>ä½ çš„æƒ…ç·’èª¿è‰²ç›¤å·²æˆåŠŸä¸Šå‚³ï¼æ„Ÿè¬ä½ ç”¨è‰²å½©èˆ‡ç·šæ¢åˆ†äº«ä½ çš„å…§å¿ƒä¸–ç•Œã€‚";
            btn.innerText = "æ„Ÿè¬åƒèˆ‡ï¼";
        }
    </script>
</body>
</html>
