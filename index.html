// --- 核心邏輯：情緒與危機偵測 ---
function processFeedback(mood, desc) {
    // 1. 定義危險關鍵字
    const dangerWords = ["自殺", "想死", "離開世界", "解脫", "沒意義", "絕望", "痛苦到極點"];
    const isCrisis = dangerWords.some(word => desc.includes(word));

    if (isCrisis) {
        // 觸發防自殺與深度關懷機制
        return {
            title: "💡 溫暖的小提醒",
            text: "看見你這幅畫，能感受到你現在承受著很大的重量... 辛苦你了。這份情緒是真實的，但也請記得，你並不孤單。試著傳個訊息給最信任的朋友，或是撥打 1925 (依政府熱線)，讓有人能陪你分擔這一刻。你的生命如同你選的顏色一樣，有無窮的可能性。",
            style: "border-left: 8px solid #ff7675; background: #fff5f5;"
        };
    }

    // 2. 一般激勵機制 (AI 回饋組)
    const normalizedFeedbacks = {
        "喜": "這抹色彩真耀眼！你的筆觸像是帶著笑意在跳舞，連螢幕前的我也感受到這份能量了呢！☀️",
        "怒": "很有張力的表達！你成功把那種噴發的能量轉化為視覺藝術，這是一個超棒的抒發過程！🔥",
        "哀": "這幅畫有種靜謐的美。雖然線條帶著淡淡的憂傷，但也是在溫柔地擁抱內心的自己。抱一個，你做得很棒。🕯️",
        "樂": "太燦爛了！這種構圖讓人看了心情也跟著輕快起來。謝謝你分享這麼美好的視覺節奏！🌈"
    };

    return {
        title: "🌟 AI 觀察筆記",
        text: normalizedFeedbacks[mood] || "你的表達很有獨特性！",
        style: "border-left: 8px solid #f1c40f; background: #fff9db;"
    };
}

// --- 更新後的跳轉邏輯 ---
function nextStep() {
    const sid = document.getElementById('sid').value;
    const age = document.getElementById('age').value;
    const desc = document.getElementById('mood-desc').value.trim();

    if(!sid || !age || !hasDrawn || desc.length < 2) return alert("請完成所有填寫與繪圖！");

    const currentMood = moods[step];
    const fbData = processFeedback(currentMood, desc);

    finalData.push({
        id: sid, age: age, gender: document.getElementById('gender').value,
        group: document.getElementById('group-type').value,
        mood_tag: currentMood, color_h: document.getElementById('colorSlider').value,
        description: desc, time: Math.round((Date.now()-startTime)/1000)+"s",
        image: canvas.toDataURL('image/jpeg', 0.5)
    });

    if (document.getElementById('group-type').value === "AI") {
        const fbBox = document.getElementById('feedback-box');
        document.getElementById('fb-title').innerText = fbData.title;
        document.getElementById('fb-text').innerText = fbData.text;
        fbBox.style.cssText += fbData.style; // 套用特殊樣式
        
        document.getElementById('overlay').style.display = "block";
        fbBox.style.display = "block";
    } else {
        processNext(); 
    }
}
