<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æƒ…ç·’è¦–è¦ºç ”ç©¶å¯¦é©—å®¤</title>
    <style>
        :root { --primary: #6c5ce7; --bg: #f1f3f6; }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); width: 550px; }
        
        /* é€²åº¦æ¢ */
        .progress-bar { display: flex; margin-bottom: 20px; background: #eee; border-radius: 10px; height: 8px; }
        .progress-inner { background: var(--primary); width: 25%; transition: 0.5s; border-radius: 10px; }
        
        .mood-tag { font-size: 26px; font-weight: bold; color: var(--primary); text-align: center; margin-bottom: 15px; }
        
        /* å¼·åŒ–ç‰ˆè‰²ç›¤ */
        .color-palette { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .color-dot { width: 35px; height: 35px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; transition: 0.2s; }
        .color-dot.active { border-color: #333; transform: scale(1.1); }
        .custom-color { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #ddd; overflow: hidden; cursor: pointer; }

        /* ç•«å¸ƒå€åŸŸ */
        .canvas-box { border: 3px solid #eee; border-radius: 20px; background: white; position: relative; overflow: hidden; }
        canvas { 
            display: block; 
            width: 100%; 
            touch-action: none; 
            /* 1. ä¿®æ”¹ç•«ç­†åœ–æ¨™ï¼šä½¿ç”¨ä¸€éš»å¯æ„›çš„ç•«ç­†åœ–æ¡ˆ */
            cursor: url('https://cdn-icons-png.flaticon.com/32/595/595582.png') 0 32, crosshair; 
        }
        
        .toolbar { display: flex; padding: 12px; background: #f8f9fa; border-bottom: 1px solid #eee; align-items: center; }
        
        #mood-desc { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 15px; margin: 15px 0; box-sizing: border-box; resize: none; font-size: 15px; outline: none; }
        .btn-next { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 18px; cursor: pointer; font-weight: bold; font-size: 18px; }
        
        /* AI å›é¥‹æ–¹æ¡† */
        #ai-res { display: none; margin-top: 20px; padding: 20px; background: #fff9db; border-radius: 15px; border-left: 6px solid #f1c40f; line-height: 1.6; }
    </style>
</head>
<body>
    <div class="card">
        <div class="progress-bar"><div class="progress-inner" id="progress"></div></div>
        
        <div id="setup-ui" style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="text" id="sid" placeholder="è¼¸å…¥å­¸è™Ÿ" style="flex:2; padding:10px; border-radius:10px; border:1px solid #eee;">
            <select id="gender" style="flex:1; padding:10px; border-radius:10px; border:1px solid #eee;">
                <option value="å¥³">å¥³</option>
                <option value="ç”·">ç”·</option>
            </select>
        </div>

        <div class="mood-tag" id="mood-label">å–œ</div>

        <div class="color-palette" id="palette">
            <div class="color-dot active" style="background:#ff7675;" onclick="pickColor('#ff7675', this)"></div>
            <div class="color-dot" style="background:#fdcb6e;" onclick="pickColor('#fdcb6e', this)"></div>
            <div class="color-dot" style="background:#55efc4;" onclick="pickColor('#55efc4', this)"></div>
            <div class="color-dot" style="background:#74b9ff;" onclick="pickColor('#74b9ff', this)"></div>
            <div class="color-dot" style="background:#a29bfe;" onclick="pickColor('#a29bfe', this)"></div>
            <div class="color-dot" style="background:#2d3436;" onclick="pickColor('#2d3436', this)"></div>
            <input type="color" id="customColorPicker" class="custom-color" onchange="pickColor(this.value, this)">
        </div>

        <div class="canvas-box">
            <div class="toolbar">
                <span style="font-size: 13px; color:#888;">è«‹ç”¨ç·šæ¢æˆ–åœ–åƒæç¹ªæƒ…ç·’...</span>
                <button onclick="clearCanvas()" style="margin-left:auto; border:none; background:none; color:var(--primary); cursor:pointer;">â™»ï¸ æ¸…ç©º</button>
            </div>
            <canvas id="canvas" width="490" height="350"></canvas>
        </div>

        <textarea id="mood-desc" rows="2" placeholder="ç‚ºä»€éº¼æœƒç•«é€™äº›ç·šæ¢æˆ–åœ–åƒå‘¢ï¼Ÿ"></textarea>

        <button class="btn-next" id="action-btn" onclick="nextStep()">ä¿å­˜ç•¶å‰æƒ…ç·’ï¼Œç¹¼çºŒ âœ¨</button>
        
        <div id="ai-res"></div>
    </div>

    <script>
        const SCRIPT_URL = "åœ¨æ­¤è²¼ä¸Šä½ çš„GoogleScriptç¶²å€";
        const moods = ["å–œ", "æ€’", "å“€", "æ¨‚"];
        const aiFeedbacks = {
            "å–œ": "é™½å…‰èˆ¬çš„ç·šæ¢ï¼ä½ çš„ç­†è§¸è·³å‹•è‘—æ„‰æ‚…çš„æ—‹å¾‹å‘¢ï½âœ¨",
            "æ€’": "å¼·çƒˆè€Œæœ‰åŠ›ï¼é€™äº›ç·šæ¢æº–ç¢ºåœ°æ•æ‰åˆ°äº†çˆ†ç™¼çš„èƒ½é‡ï¼ğŸ”¥",
            "å“€": "æº«æŸ”è€Œå®‰éœï¼Œç·šæ¢ä¸­å¸¶è‘—ä¸€ç¨®æ·±é‚ƒçš„è©©æ„...ğŸ•¯ï¸",
            "æ¨‚": "å’Œè«§çš„æ§‹åœ–ï¼æ„Ÿè¦ºå¿ƒæƒ…éƒ½è·Ÿè‘—ä½ çš„ç•«ä½œé£›æšäº†èµ·ä¾†ï½ğŸŒˆ"
        };

        let step = 0;
        let finalData = [];
        let startTime = Date.now();
        let selectedColor = "#ff7675";

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        function clearCanvas() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        clearCanvas();

        function pickColor(c, el) {
            selectedColor = c;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
            if(el.classList) el.classList.add('active');
        }

        canvas.addEventListener('mousedown', (e) => { 
            drawing = true;
            ctx.beginPath();
            const r = canvas.getBoundingClientRect();
            ctx.moveTo(e.clientX - r.left, e.clientY - r.top);
        });
        canvas.addEventListener('mousemove', (e) => {
            if(!drawing) return;
            const r = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - r.left, e.clientY - r.top);
            ctx.strokeStyle = selectedColor;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
        });
        window.addEventListener('mouseup', () => drawing = false);

        async function nextStep() {
            const sid = document.getElementById('sid').value;
            if(!sid) return alert("è«‹å¡«å¯«å­¸è™Ÿï¼");

            const imageData = canvas.toDataURL('image/jpeg', 0.5);
            const duration = Math.round((Date.now() - startTime) / 1000);

            finalData.push({
                id: sid,
                gender: document.getElementById('gender').value,
                mood_tag: moods[step],
                color: selectedColor,
                description: document.getElementById('mood-desc').value,
                time_spent: duration + "s",
                image: imageData,
                ai_fb: aiFeedbacks[moods[step]]
            });

            if(step < 3) {
                step++;
                startTime = Date.now();
                document.getElementById('mood-label').innerText = moods[step];
                document.getElementById('progress').style.width = ((step + 1) * 25) + "%";
                document.getElementById('setup-ui').style.visibility = "hidden";
                document.getElementById('mood-desc').value = "";
                clearCanvas();
                if(step === 3) document.getElementById('action-btn').innerText = "é€å‡ºæ‰€æœ‰å¯¦é©—æ•¸æ“š âœ¨";
            } else {
                submitFinal();
            }
        }

        async function submitFinal() {
            const btn = document.getElementById('action-btn');
            btn.disabled = true;
            btn.innerText = "æ­£åœ¨åŒæ­¥å¯¦é©—æ•¸æ“š... ğŸš€";

            for(let item of finalData) {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(item)
                });
            }

            // é¡¯ç¤ºæœ€çµ‚ç¶œåˆ AI å›é¥‹
            const aiRes = document.getElementById('ai-res');
            aiRes.style.display = "block";
            aiRes.innerHTML = "<strong>ã€æƒ…ç·’èª¿è‰²ç›¤ç¸½çµã€‘</strong><br>å¤ªæ£’äº†ï¼ä½ å®Œæˆäº†ä¸€æ¬¡æ·±åº¦çš„è‡ªæˆ‘æ¢ç´¢ã€‚ä½ ç”¨ç¹½ç´›çš„è‰²å½©èˆ‡ç­†è§¸è¨˜éŒ„äº†å–œã€æ€’ã€å“€ã€æ¨‚ã€‚æ¯ä¸€æ¢æ›²ç·šéƒ½æ˜¯å¿ƒéˆçš„è»Œè·¡ï¼Œè€å¸«æœƒå¥½å¥½çæƒœé€™äº›å¯¶è²´çš„æ•¸æ“šï¼ğŸ’–";
            
            btn.innerText = "å¯¦é©—å·²å…¨éƒ¨å®Œæˆï¼";
            alert("æäº¤æˆåŠŸï¼");
        }
    </script>
</body>
</html>
